<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper为映射的根节点，配置各类声明-->
<!-- namespace指定Dao接口的完整类名，由于映射文件可能有多个，为了防止crud语句的唯一标识被重复，需要设置空间名称 -->
<!-- mybatis会依据这个接口动态创建一个实现类去实现这个接口，而这个实现类是一个Mapper对象-->

<mapper namespace="org.x.backend.mapper.OmdPublicMapper">

    <!-- 
    select：查询的statement（声明），用来编写查询语句
    id：语句的唯一标识，要与dao层的函数名一致
    resultType：配置返回的结果集类型
    parameterType：传递的参数类型，可以省略
    -->


    <!-- 查询榜单音乐信息结果映射定义 -->
    <resultMap id="MusicInfoWithSingerMap" type="OmdMusicInfo">
        <id property="omdMusicInfoId" column="omd_music_info_id" />
        <result property="omdMusicInfoName" column="omd_music_info_name" />
        <result property="omdMusicInfoAlbum" column="omd_music_info_album" />
        <result property="omdMusicInfoDuration" column="omd_music_info_duration" />
        <result property="omdMusicInfoSongUrl" column="omd_music_info_song_url" />
        <result property="omdMusicInfoCoverUrl" column="omd_music_info_cover_url" />
        <result property="omdMusicInfoGenre" column="omd_music_info_genre" />
        <result property="omdSingerId" column="omd_singer_id" />
        <result property="omdMusicInfoStatus" column="omd_music_info_status" />
        <result property="omdMusicInfoCreateTime" column="omd_music_info_create_time" />
        <result property="omdMusicInfoUpdateTime" column="omd_music_info_update_time" />

        <association property="omdSinger" javaType="OmdSinger">
            <id property="omdSingerId" column="omd_singer_id" />
            <result property="omdSingerName" column="omd_singer_name" />
            <!-- 添加OmdSinger实体类的其他字段映射 -->
        </association>
    </resultMap>

    <!-- 查询榜单音乐信息 -->
    <select id="getMusicInfoByIdList" resultMap="MusicInfoWithSingerMap">
        SELECT
        m.*,
        s.omd_singer_name
        FROM
        tb_omd_music_info m
        LEFT JOIN tb_omd_singer s ON m.omd_singer_id = s.omd_singer_id
        WHERE
        m.omd_music_info_status = 1
        and
        m.omd_music_info_id IN
        <foreach collection="omdMusicInfoIdList" item="omdMusicInfoId" open="(" separator="," close=")">
            #{omdMusicInfoId}
        </foreach>
    </select>


    <!-- 查询随机歌手信息结果映射定义 -->
    <resultMap id="SingerInfoWithUserAvatar" type="OmdSinger">
        <id property="omdSingerId" column="omd_singer_id" />
        <result property="omdSingerName" column="omd_singer_name" />
        <result property="omdSingerIntroduction" column="omd_singer_introduction" />
        <result property="omdSingerRepresentativeSing" column="omd_singer_representative_sing" />
        <result property="omdSingerGenre" column="omd_singer_genre" />
        <result property="omdSingerLabel" column="omd_singer_label" />
        <result property="omdSingerStatus" column="omd_singer_status" />

        <association property="omdUser" javaType="OmdUser">
            <id property="omdUserId" column="omd_user_id" />
            <result property="omdUserAvatar" column="omd_user_avatar" />
        </association>
    </resultMap>

    <!-- 查询随机歌手信息 -->
    <select id="getRandomSingersInfo" resultMap="SingerInfoWithUserAvatar">
        SELECT
        s.*,
        u.omd_user_avatar
        FROM
        tb_omd_singer s
        JOIN tb_omd_user u ON s.omd_user_id = u.omd_user_id
        ORDER BY rand() LIMIT 3
    </select>


    <!-- 查询歌单的评论信息结果映射定义 -->
    <resultMap id="MusicCommentMap" type="OmdMusicComment">
        <id property="omdMusicCommentId" column="omd_music_comment_id" />
        <result property="omdMusicInfoId" column="omd_music_info_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdMusicCommentContent" column="omd_music_comment_content" />
        <result property="omdMusicCommentLikeCount" column="omd_music_comment_like_count" />
        <result property="omdMusicCommentParentId" column="omd_music_comment_parent_id" />
        <result property="omdMusicCommentReplyCount" column="omd_music_comment_reply_count" />
        <result property="omdMusicCommentStatus" column="omd_music_comment_status"/>
        <result property="omdMusicCommentCreateTime" column="omd_music_comment_create_time" />
        <result property="omdMusicCommentUpdateTime" column="omd_music_comment_update_time" />

        <!-- 关联查询用户信息 -->
        <association property="omdUser" javaType="OmdUser">
            <id property="omdUserId" column="omd_user_id" />
            <result property="omdUserAvatar" column="omd_user_avatar" />
            <result property="omdUserNickname" column="omd_user_nickname" />
            <result property="omdUserName" column="omd_user_name" />
        </association>

        <!-- 子评论集合映射（明确排除代理属性） -->
        <collection property="omdMusicCommentReplies"
                    ofType="OmdMusicComment"
                    select="getChildCommentsByParentId"
                    column="omd_music_comment_id"
                    fetchType="lazy" >
            <constructor>
                <arg name="omdMusicCommentId" column="omd_music_comment_id" />
                <arg name="omdMusicCommentContent" column="omd_music_comment_content" />
                <arg name="omdMusicCommentLikeCount" column="omd_music_comment_like_count" />
                <arg name="omdMusicCommentParentId" column="omd_music_comment_parent_id" />
                <arg name="omdMusicCommentReplyCount" column="omd_music_comment_reply_count" />
                <arg name="omdMusicCommentStatus" column="omd_music_comment_status" />
                <arg name="omdMusicCommentCreateTime" column="omd_music_comment_create_time" />
                <arg name="omdMusicCommentUpdateTime" column="omd_music_comment_update_time" />
                <arg name="omdUser" column="omd_user_id" />
            </constructor>
        </collection>
    </resultMap>

    <!-- 查询歌单的评论信息列表 -->
    <select id="getMusicCommentListByMusicId" resultMap="MusicCommentMap">
        SELECT
            mc.*,
            u.omd_user_avatar,
            u.omd_user_nickname,
            u.omd_user_name
        FROM
            tb_omd_music_comment mc
                JOIN tb_omd_user u ON mc.omd_user_id = u.omd_user_id
        WHERE
            mc.omd_music_info_id = #{omdMusicInfoId} -- 歌单ID
          AND mc.omd_music_comment_parent_id = 0 -- 只查询一级评论
          AND mc.omd_music_comment_status = 1 -- 只查询审核通过的评论
        ORDER BY mc.omd_music_comment_create_time DESC
    </select>

    <!-- 查询子评论 -->
    <select id="getChildCommentsByParentId" resultMap="MusicCommentMap">
        -- 查询指定评论的子评论（带分页）
        SELECT
            c.*,
            u.omd_user_nickname,
            u.omd_user_avatar,
            u.omd_user_name
        FROM
            tb_omd_music_comment c
                JOIN
            tb_omd_user u ON c.omd_user_id = u.omd_user_id
        WHERE
            c.omd_music_comment_parent_id = #{omdMusicCommentId}  -- 父评论ID
          AND c.omd_music_comment_status = 1            -- 只查询审核通过的评论
        ORDER BY
            c.omd_music_comment_create_time DESC          -- 按创建时间倒序排列
    </select>


    <resultMap id="musicComment" type="OmdMusicComment">
        <id property="omdMusicCommentId" column="omd_music_comment_id" />
        <result property="omdMusicInfoId" column="omd_music_info_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdMusicCommentContent" column="omd_music_comment_content" />
        <result property="omdMusicCommentLikeCount" column="omd_music_comment_like_count" />
        <result property="omdMusicCommentCreateTime" column="omd_music_comment_create_time" />
        <result property="omdMusicCommentUpdateTime" column="omd_music_comment_update_time" />
        <association property="omdUser" javaType="OmdUser">
            <id property="omdUserId" column="omd_user_id" />
            <result property="omdUserName" column="omd_user_name" />
        </association>
    </resultMap>

    <select id="getMusicCommentByMusicId" resultMap="musicComment">
        select
            mc.*, u.omd_user_name
        from
            tb_omd_music_comment mc
                join tb_omd_user u on mc.omd_user_id = u.omd_user_id
        where
            mc.omd_music_info_id = #{omdMusicInfoId}
        ORDER BY
            mc.omd_music_comment_create_time DESC
    </select>

</mapper>