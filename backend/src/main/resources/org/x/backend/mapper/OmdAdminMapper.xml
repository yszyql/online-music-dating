<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper为映射的根节点，配置各类声明-->
<!-- namespace指定Dao接口的完整类名，由于映射文件可能有多个，为了防止crud语句的唯一标识被重复，需要设置空间名称 -->
<!-- mybatis会依据这个接口动态创建一个实现类去实现这个接口，而这个实现类是一个Mapper对象-->

<mapper namespace="org.x.backend.mapper.OmdAdminMapper">

    <!-- 
    select：查询的statement（声明），用来编写查询语句
    id：语句的唯一标识，要与dao层的函数名一致
    resultType：配置返回的结果集类型
    parameterType：传递的参数类型，可以省略
    -->
    <update id="updateAdminInfo" parameterType="OmdAdmin">
        update tb_omd_admin
        <set>
            <if test="omdAdminEmail != null">
                omd_admin_email = #{omdAdminEmail},
            </if>
            <if test="omdAdminAvatar != null">
                omd_admin_avatar = #{omdAdminAvatar},
            </if>
            omd_admin_update_time = NOW()
        </set>
        where omd_admin_id = #{omdAdminId}
    </update>

    <resultMap id="commentReportWitComment" type="OmdCommentReport">
        <id property="omdCommentReportId" column="omd_comment_report_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdMusicCommentId" column="omd_music_comment_id" />
        <result property="omdCommentReportReason" column="omd_comment_report_reason" />
        <result property="omdCommentReportDescription" column="omd_comment_report_description" />
        <result property="omdCommentReportStatus" column="omd_comment_report_status" />
        <result property="omdCommentReportRemark" column="omd_comment_report_remark" />
        <result property="omdAdminName" column="omd_admin_name" />
        <result property="omdCommentReportHandleTime" column="omd_comment_report_handle_time" />
        <result property="omdCommentReportCreateTime" column="omd_comment_report_create_time" />
        <association property="omdMusicComment" javaType="OmdMusicComment">
            <id property="omdMusicCommentId" column="omd_music_comment_id" />
            <result property="omdMusicCommentContent" column="omd_music_comment_content" />
        </association>
    </resultMap>

    <select id="getCommentReportListByStatus" resultMap="commentReportWitComment">
        select
            cr.*, mc.omd_music_comment_content
        from
            tb_omd_comment_report cr
                join tb_omd_music_comment mc on cr.omd_music_comment_id = mc.omd_music_comment_id
        where
            cr.omd_comment_report_status = 0
        order by
            cr.omd_comment_report_create_time desc
    </select>

    <resultMap id="operationLogWithAdmin" type="OmdOperationLog">
        <id property="omdOperationLogId" column="omd_operation_log_id" />
        <result property="omdAdminId" column="omd_admin_id" />
        <result property="omdOperationLogTargetId" column="omd_operation_log_target_id" />
        <result property="omdOperationLogTargetType" column="omd_operation_log_target_type" />
        <result property="omdOperationLogType" column="omd_operation_log_type" />
        <result property="omdOperationLogDesc" column="omd_operation_log_desc" />
        <result property="omdOperationLogTime" column="omd_operation_log_time" />
        <association property="omdAdmin" javaType="OmdAdmin">
            <id property="omdAdminId" column="omd_admin_id" />
            <result property="omdAdminName" column="omd_admin_name" />
        </association>
    </resultMap>

    <select id="getOperationLogList" resultMap="operationLogWithAdmin">
        select
            ol.*, a.omd_admin_name
        from
            tb_omd_operation_log ol
                join tb_omd_admin a on ol.omd_admin_id = a.omd_admin_id
        order by
            ol.omd_operation_log_time desc
    </select>

    <select id="getOperationLogListByType" resultMap="operationLogWithAdmin">
        SELECT
            ol.*, a.omd_admin_name
        FROM
            tb_omd_operation_log ol
                JOIN tb_omd_admin a ON ol.omd_admin_id = a.omd_admin_id
        WHERE
            ol.omd_operation_log_target_type = #{targetTypes}
        ORDER BY
            ol.omd_operation_log_time DESC
    </select>

    <resultMap id="userReport" type="OmdUserReport">
        <id property="omdUserReportId" column="omd_user_report_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdUserReportedUserId" column="omd_user_reported_user_id" />
        <result property="omdUserReportReason" column="omd_user_report_reason" />
        <result property="omdUserReportType" column="omd_user_report_type" />
        <result property="omdUserReportStatus" column="omd_user_report_status" />
        <result property="omdUserReportEvidence" column="omd_user_report_evidence" />
        <result property="omdAdminId" column="omd_admin_id" />
        <result property="omdUserReportHandleRemark" column="omd_user_report_handle_remark" />
        <result property="omdUserReportCreateTime" column="omd_user_report_create_time" />
        <result property="omdUserReportHandleTime" column="omd_user_report_handle_time" />
        <association property="omdUser" javaType="OmdUser">
            <id property="omdUserId" column="omd_user_id" />
            <result property="omdUserAvatar" column="omd_user_avatar" />
            <result property="omdUserNickname" column="omd_user_nickname" />
            <result property="omdUserName" column="omd_user_name" />
        </association>
        <association property="omdReportedUser" javaType="OmdUser">
            <id property="omdUserId" column="reported_user_id" />
            <result property="omdUserAvatar" column="reported_user_avatar" />
            <result property="omdUserNickname" column="reported_user_nickname" />
            <result property="omdUserName" column="reported_user_name" />
        </association>
    </resultMap>

    <select id="findUserReportById" resultMap="userReport">
        SELECT
            ur.*, u.omd_user_avatar, u.omd_user_nickname, u.omd_user_name
        FROM
            tb_omd_user_report ur
                JOIN tb_omd_user u ON ur.omd_user_reported_user_id = u.omd_user_id
        WHERE
            ur.omd_user_report_id = #{omdUserReportId}
    </select>

    <select id="getUserReportList" resultMap="userReport">
        SELECT
            ur.*,
            u2.omd_user_id,
            u2.omd_user_avatar,
            u2.omd_user_nickname,
            u2.omd_user_name,
            u.omd_user_id as reported_user_id,
            u.omd_user_avatar as reported_user_avatar,
            u.omd_user_nickname as reported_user_nickname,
            u.omd_user_name as reported_user_name
        FROM
            tb_omd_user_report ur
                JOIN tb_omd_user u ON ur.omd_user_reported_user_id = u.omd_user_id
                JOIN tb_omd_user u2 ON ur.omd_user_id = u2.omd_user_id
        WHERE
            ur.omd_user_report_status = 0
        ORDER BY
            ur.omd_user_report_create_time DESC
    </select>

    <resultMap id="musicReport" type="OmdMusicReport">
        <id property="omdMusicReportId" column="omd_music_report_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdMusicInfoId" column="omd_music_info_id" />
        <result property="omdMusicReportReason" column="omd_music_report_reason" />
        <result property="omdMusicReportType" column="omd_music_report_type" />
        <result property="omdMusicReportStatus" column="omd_music_report_status" />
        <result property="omdMusicReportEvidence" column="omd_music_report_evidence" />
        <result property="omdAdminId" column="omd_admin_id" />
        <result property="omdMusicReportHandleRemark" column="omd_music_report_handle_remark" />
        <result property="omdMusicReportCreateTime" column="omd_music_report_create_time" />
        <result property="omdMusicReportHandleTime" column="omd_music_report_handle_time" />
        <association property="omdReportedMusic" javaType="OmdMusicInfo">
            <id property="omdMusicInfoId" column="omd_music_info_id" />
            <result property="omdMusicInfoName" column="omd_music_info_name" />
            <result property="omdMusicInfoCoverUrl" column="omd_music_info_cover_url" />
            <result property="omdMusicInfoSongUrl" column="omd_music_info_song_url" />
        </association>
    </resultMap>

    <select id="findMusicReportById" resultMap="musicReport">
        SELECT
            mr.*, m.omd_music_info_name, m.omd_music_info_cover_url, m.omd_music_info_song_url
        FROM
            tb_omd_music_report mr
                JOIN tb_omd_music_info m ON mr.omd_music_info_id = m.omd_music_info_id
        WHERE
            mr.omd_music_report_id = #{omdMusicReportId}
    </select>

    <select id="getMusicReportList" resultMap="musicReport">
        SELECT
            mr.*, m.omd_music_info_name, m.omd_music_info_cover_url, m.omd_music_info_song_url
        FROM
            tb_omd_music_report mr
                JOIN tb_omd_music_info m ON mr.omd_music_info_id = m.omd_music_info_id
        where mr.omd_music_report_status = 0
        ORDER BY
            mr.omd_music_report_create_time DESC
    </select>

    <resultMap id="userAppeal" type="OmdUserAppeal">
        <id property="omdUserAppealId" column="omd_user_appeal_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdUserAppealReason" column="omd_user_appeal_reason" />
        <result property="omdUserAppealStatus" column="omd_user_appeal_status" />
        <result property="omdAdminId" column="omd_admin_id" />
        <result property="omdUserAppealResult" column="omd_user_appeal_result" />
        <result property="omdUserAppealCreateTime" column="omd_user_appeal_create_time" />
        <result property="omdUserAppealHandleTime" column="omd_user_appeal_handle_time" />
        <association property="omdAppealUser" javaType="OmdUser">
            <id property="omdUserId" column="omd_user_id" />
            <result property="omdUserAvatar" column="omd_user_avatar" />
            <result property="omdUserNickname" column="omd_user_nickname" />
            <result property="omdUserName" column="omd_user_name" />
        </association>
    </resultMap>

    <select id="findUserAppealById" resultMap="userAppeal">
        SELECT
            ua.*, u.omd_user_avatar, u.omd_user_nickname, u.omd_user_name
        FROM
            tb_omd_user_appeal ua
                JOIN tb_omd_user u ON ua.omd_user_id = u.omd_user_id
        WHERE
            ua.omd_user_appeal_id = #{omdUserAppealId}
    </select>

    <select id="getUserAppealList" resultMap="userAppeal">
        SELECT
            ua.*, u.omd_user_avatar, u.omd_user_nickname, u.omd_user_name
        FROM
            tb_omd_user_appeal ua
                JOIN tb_omd_user u ON ua.omd_user_id = u.omd_user_id
        where ua.omd_user_appeal_status = 0
        ORDER BY
            ua.omd_user_appeal_create_time DESC
    </select>

    <resultMap id="musicAppeal" type="OmdMusicAppeal">
        <id property="omdMusicAppealId" column="omd_music_appeal_id" />
        <result property="omdSingerId" column="omd_singer_id" />
        <result property="omdMusicInfoId" column="omd_music_info_id" />
        <result property="omdMusicAppealReason" column="omd_music_appeal_reason" />
        <result property="omdMusicAppealEvidence" column="omd_music_appeal_evidence" />
        <result property="omdMusicAppealStatus" column="omd_music_appeal_status" />
        <result property="omdAdminId" column="omd_admin_id" />
        <result property="omdMusicAppealHandleRemark" column="omd_music_appeal_handle_remark" />
        <result property="omdMusicAppealCreateTime" column="omd_music_appeal_create_time" />
        <result property="omdMusicAppealHandleTime" column="omd_music_appeal_handle_time" />
        <association property="omdAppealMusicInfo" javaType="OmdMusicInfo">
            <id property="omdMusicInfoId" column="omd_music_info_id" />
            <result property="omdMusicInfoName" column="omd_music_info_name" />
            <result property="omdMusicInfoCoverUrl" column="omd_music_info_cover_url" />
            <result property="omdMusicInfoSongUrl" column="omd_music_info_song_url" />
        </association>
    </resultMap>

    <select id="findMusicAppealById" resultMap="musicAppeal">
        SELECT
            ma.*, m.omd_music_info_name, m.omd_music_info_cover_url, m.omd_music_info_song_url
        FROM
            tb_omd_music_appeal ma
                JOIN tb_omd_music_info m ON ma.omd_music_info_id = m.omd_music_info_id
        WHERE
            ma.omd_music_appeal_id = #{omdMusicAppealId}
    </select>

    <select id="getMusicAppealList" resultMap="musicAppeal">
        SELECT
            ma.*, m.omd_music_info_name, m.omd_music_info_cover_url, m.omd_music_info_song_url
        FROM
            tb_omd_music_appeal ma
                JOIN tb_omd_music_info m ON ma.omd_music_info_id = m.omd_music_info_id
        where ma.omd_music_appeal_status = 0
        ORDER BY
            ma.omd_music_appeal_create_time DESC
    </select>

    <resultMap id="commentReport" type="OmdCommentReport">
        <id property="omdCommentReportId" column="omd_comment_report_id" />
        <result property="omdUserId" column="omd_user_id" />
        <result property="omdMusicCommentId" column="omd_music_comment_id" />
        <result property="omdCommentReportReason" column="omd_comment_report_reason" />
        <result property="omdCommentReportDescription" column="omd_comment_report_description" />
        <result property="omdCommentReportStatus" column="omd_comment_report_status" />
        <result property="omdCommentReportRemark" column="omd_comment_report_remark" />
        <result property="omdAdminName" column="omd_admin_name" />
        <result property="omdCommentReportHandleTime" column="omd_comment_report_handle_time" />
        <result property="omdCommentReportCreateTime" column="omd_comment_report_create_time" />
        <association property="omdMusicComment" javaType="OmdMusicComment">
            <id property="omdMusicCommentId" column="omd_music_comment_id" />
            <result property="omdMusicCommentContent" column="omd_music_comment_content" />
        </association>
    </resultMap>

    <select id="getCommentReportByCommentId" resultMap="commentReport">
        select
            cr.*, mc.omd_music_comment_content
        from
            tb_omd_comment_report cr
                join tb_omd_music_comment mc on cr.omd_music_comment_id = mc.omd_music_comment_id
        where
            cr.omd_comment_report_id = #{omdCommentReportId}
        order by
            cr.omd_comment_report_create_time desc
    </select>

</mapper>